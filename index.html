<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Islamic Prayer - أوقات الصلاة</title>
    
    <!-- Fonts & Libraries -->
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        amiri: ['Amiri', 'serif'],
                        kanit: ['Kanit', 'sans-serif'],
                    },
                    colors: {
                        primary: '#064439',
                        accent: '#2e7d32',
                    }
                }
            }
        }
    </script>
    
    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #f0f2f1; margin: 0; display: flex; justify-content: center; }
        .app-shell { width: 100%; max-width: 430px; background: #fff; min-height: 100vh; display: flex; flex-direction: column; position: relative; box-shadow: 0 0 60px rgba(0,0,0,0.15); }
        
        .font-amiri { font-family: 'Amiri', serif !important; }
        .font-kanit { font-family: 'Kanit', sans-serif !important; }

        /* Enhanced Glow Effect */
        .active-glow {
            position: relative;
            box-shadow: 0 0 30px 10px rgba(6, 68, 57, 0.3);
            border: 3px solid rgba(6, 68, 57, 0.5);
            background: linear-gradient(145deg, #ffffff, #f9fbf9);
            animation: pulse-glow 2s ease-in-out infinite;
        }
        
        @keyframes pulse-glow {
            0%, 100% {
                box-shadow: 0 0 30px 10px rgba(6, 68, 57, 0.3);
                border-color: rgba(6, 68, 57, 0.5);
            }
            50% {
                box-shadow: 0 0 50px 15px rgba(6, 68, 57, 0.5);
                border-color: rgba(6, 68, 57, 0.8);
            }
        }
        
        .active-glow::after {
            content: '';
            position: absolute;
            inset: -3px;
            border-radius: 32px;
            padding: 3px;
            background: linear-gradient(45deg, #064439, #2e7d32, #00bcd4, #064439);
            background-size: 300% 300%;
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            animation: rotate-glow 3s linear infinite;
        }
        
        @keyframes rotate-glow { 
            0% { background-position: 0% 50%; filter: hue-rotate(0deg); } 
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; filter: hue-rotate(360deg); } 
        }

        .hijri-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
        .hijri-cell { aspect-ratio: 1/1.1; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 14px; border: 1px solid #f1f5f9; background: #f8fafc; transition: all 0.3s; }
        .hijri-cell.active { background: #064439; color: white; border-color: #064439; box-shadow: 0 8px 15px rgba(6, 68, 57, 0.3); transform: scale(1.05); }

        .admin-card { 
            background: linear-gradient(145deg, #ffffff, #f9fafb);
            padding: 28px; 
            border-radius: 28px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.08); 
            border: 1px solid #e5e7eb; 
            margin-bottom: 24px;
            transition: all 0.3s;
        }
        .admin-card:hover {
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
            transform: translateY(-2px);
        }
        .admin-input { 
            width: 100%; 
            padding: 14px 18px; 
            border-radius: 14px; 
            border: 2px solid #e5e7eb; 
            outline: none; 
            transition: all 0.3s; 
            font-family: 'Kanit', sans-serif; 
            font-size: 14px;
            background: #ffffff;
        }
        .admin-input:focus { 
            border-color: #064439;
            box-shadow: 0 0 0 4px rgba(6, 68, 57, 0.1);
        }
        .admin-label { 
            font-size: 11px; 
            font-weight: 700; 
            color: #6b7280; 
            text-transform: uppercase; 
            letter-spacing: 0.1em; 
            margin-bottom: 8px; 
            display: block; 
            margin-left: 4px;
        }
        .admin-btn {
            width: 100%;
            padding: 16px;
            border-radius: 16px;
            font-weight: 700;
            font-family: 'Kanit', sans-serif;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            transition: all 0.3s;
            border: none;
            cursor: pointer;
        }
        .admin-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(0,0,0,0.2);
        }

        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #064439;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255,255,255,0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(4px);
        }
    </style>
</head>
<body class="font-kanit">

<!-- Loading Screen -->
<div id="loadingScreen" class="loading-overlay">
    <div class="text-center">
        <div class="spinner mx-auto mb-4"></div>
        <p class="text-primary font-bold text-lg font-kanit">กำลังโหลดข้อมูล...</p>
        <p class="text-gray-400 text-sm font-kanit mt-2">กรุณารอสักครู่</p>
    </div>
</div>

<div class="app-shell">
    <!-- Header Section -->
    <div class="flex justify-between items-start p-6 pt-10 pb-4">
        <div class="flex flex-col">
            <h1 class="font-amiri text-3xl text-primary leading-tight" id="topHijri">--</h1>
            <div class="text-xs font-light text-gray-400 mt-1 font-kanit" id="topGregorian">--</div>
        </div>
        <div class="text-right">
            <div class="text-2xl font-bold text-primary tracking-tight font-kanit" id="liveClock">00:00:00</div>
            <div class="flex items-center justify-end gap-1 text-accent text-xs mt-1 font-kanit">
                <i data-lucide="map-pin" class="w-3.5 h-3.5"></i>
                <span id="locLabel">ยะลา</span>
            </div>
        </div>
    </div>

    <!-- Active Prayer Card -->
    <div class="mx-6 my-4 bg-white rounded-[32px] p-8 relative overflow-hidden active-glow">
        <div class="absolute top-6 right-8 bg-red-500 text-white text-[10px] font-bold px-3 py-1 rounded-full tracking-wider animate-pulse font-kanit z-10">
            NOW
        </div>
        
        <div class="flex justify-between items-center relative z-10">
            <div class="flex flex-col">
                <p class="font-amiri text-6xl text-primary mb-2" id="nowArName">--</p>
                <div class="text-7xl font-bold text-primary tracking-tighter font-kanit" id="nowTimeVal">00:00</div>
                <div class="mt-6 inline-flex items-center px-4 py-2 bg-red-50 rounded-full border border-red-100">
                    <p class="text-red-500 text-[11px] font-semibold font-kanit" id="countdown">คำนวณเวลา...</p>
                </div>
            </div>
            <div class="p-6 rounded-full bg-gray-50" id="nowIconContainer">
                <i id="nowIcon" data-lucide="clock" class="text-gray-400 w-16 h-16"></i>
            </div>
        </div>
    </div>

    <!-- Prayer Grid -->
    <div class="grid grid-cols-3 gap-3 px-6 mt-4" id="prayerGrid"></div>

    <!-- City Selector -->
    <div class="px-6 mt-8">
        <div class="relative">
            <select id="citySelect" onchange="updateLocation()" class="w-full appearance-none bg-gray-50 border border-gray-100 rounded-2xl px-6 py-4 text-gray-700 font-medium font-kanit cursor-pointer focus:outline-none">
                <option value="ยะลา">ยะลา</option>
                <option value="นครศรีธรรมราช">นครศรีธรรมราช / พัทลุง</option>
                <option value="จะนะ">จะนะ / เทพา</option>
                <option value="สตูล">สตูล</option>
                <option value="ตรัง">ตรัง</option>
                <option value="ปัตตานี">ปัตตานี</option>
                <option value="นราธิวาส">นราธิวาส</option>
                <option value="สุไหงโกลก">สุไหงโกลก</option>
            </select>
            <div class="absolute right-6 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none">
                <i data-lucide="chevron-down"></i>
            </div>
        </div>
    </div>

    <!-- Monthly Hijri Calendar -->
    <div class="mx-6 mt-8 mb-10 p-7 bg-white rounded-[32px] shadow-sm border border-gray-100">
        <div class="flex justify-between items-center mb-8 px-1">
            <div>
                <h3 class="font-bold text-primary text-xl font-amiri" id="calHijriMonth">--</h3>
                <p class="text-[10px] text-gray-400 font-kanit mt-1" id="calGregorianRange">--</p>
            </div>
            <div class="text-[9px] font-bold text-gray-300 uppercase tracking-[0.2em] font-kanit">HIJRI CALENDAR</div>
        </div>
        <div class="grid grid-cols-7 gap-2 mb-4">
            <div class="text-[10px] font-bold text-red-400 text-center font-kanit">อา</div>
            <div class="text-[10px] font-bold text-gray-400 text-center font-kanit">จ</div>
            <div class="text-[10px] font-bold text-gray-400 text-center font-kanit">อ</div>
            <div class="text-[10px] font-bold text-gray-400 text-center font-kanit">พ</div>
            <div class="text-[10px] font-bold text-gray-400 text-center font-kanit">พฤ</div>
            <div class="text-[10px] font-bold text-gray-400 text-center font-kanit">ศ</div>
            <div class="text-[10px] font-bold text-gray-400 text-center font-kanit">ส</div>
        </div>
        <div class="hijri-grid" id="hijriGrid"></div>
    </div>

    <!-- Admin Trigger -->
    <div class="mt-auto py-10 text-[10px] font-bold text-gray-200 tracking-[0.5em] hover:text-primary transition-all uppercase text-center cursor-pointer font-kanit" onclick="showConfig()">
        Configuration
    </div>
</div>

<!-- Config Modal -->
<div id="configModal" class="fixed inset-0 bg-black/50 z-[100] hidden flex items-center justify-center p-6" onclick="closeConfig(event)">
    <div class="bg-white rounded-[32px] p-8 max-w-md w-full" onclick="event.stopPropagation()">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold text-primary font-kanit">ตั้งค่าระบบ</h3>
            <button onclick="closeConfig()" class="text-gray-400 hover:text-primary transition-all">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>

        <!-- Google Sheets URL -->
        <div class="mb-6">
            <label class="admin-label">Google Sheets URL</label>
            <input type="text" id="sheetsUrl" class="admin-input mb-2" placeholder="https://docs.google.com/spreadsheets/d/...">
            <p class="text-xs text-gray-400 font-kanit ml-1">ต้องมี 2 Sheet: "PrayerTimes" และ "HijriCalendar"</p>
        </div>

        <button onclick="saveConfig()" class="admin-btn bg-primary text-white hover:bg-accent mb-3">
            <i data-lucide="save" class="w-4 h-4 inline mr-2"></i> บันทึกและโหลดข้อมูล
        </button>

        <button onclick="testConnection()" class="admin-btn bg-blue-600 text-white hover:bg-blue-700">
            <i data-lucide="link" class="w-4 h-4 inline mr-2"></i> ทดสอบการเชื่อมต่อ
        </button>

        <div id="configStatus" class="mt-4 p-4 rounded-xl hidden">
            <p class="text-sm font-kanit"></p>
        </div>
    </div>
</div>

<!-- Azan Audio -->
<audio id="azanAudio" preload="auto">
    <source src="https://raw.githubusercontent.com/itsutisart/prayer-times/main/azan.mp3" type="audio/mpeg">
</audio>

<script>
    // ==================== CONFIGURATION ====================
    const CONFIG = {
        sheetsUrl: localStorage.getItem('sheetsUrl') || '',
        city: localStorage.getItem('userCity') || 'ยะลา'
    };

    const OFFSETS = { 
        'ยะลา': 0, 
        'นครศรีธรรมราช': 3, 
        'จะนะ': 1, 
        'สตูล': 2, 
        'ตรัง': 4, 
        'ปัตตานี': -2, 
        'นราธิวาส': -4, 
        'สุไหงโกลก': -5 
    };

    const PRAYER_META = [
        { id: 'im', ar: 'إمساك', icon: 'clock', color: 'text-indigo-500', bg: 'bg-indigo-50' },
        { id: 'fa', ar: 'صبح', icon: 'sunrise', color: 'text-blue-400', bg: 'bg-blue-50' },
        { id: 'sh', ar: 'شروق', icon: 'sun-medium', color: 'text-orange-400', bg: 'bg-orange-50' },
        { id: 'dh', ar: 'ظهر', icon: 'sun', color: 'text-yellow-500', bg: 'bg-yellow-50' },
        { id: 'as', ar: 'عصر', icon: 'cloud-sun', color: 'text-amber-600', bg: 'bg-amber-50' },
        { id: 'ma', ar: 'مغرب', icon: 'moon-star', color: 'text-red-500', bg: 'bg-red-50' },
        { id: 'is', ar: 'عشاء', icon: 'moon', color: 'text-purple-600', bg: 'bg-purple-50' }
    ];

    const AR_NUMS = ['٠','١','٢','٣','٤','٥','٦','٧','٨','٩'];
    const AR_MONTHS = ["","محرم","صفر","ربيع الأول","ربيع الثاني","جمادى الأولى","جمادى الآخرة","رجب","شعبان","رمضان","شوال","ذو القعدة","ذو الحجة"];
    const TH_MONTHS = ["มกราคม","กุมภาพันธ์","มีนาคม","เมษายน","พฤษภาคม","มิถุนายน","กรกฎาคม","สิงหาคม","กันยายน","ตุลาคม","พฤศจิกายน","ธันวาคม"];

    // ==================== STATE ====================
    let prayerData = [];
    let hijriData = null;
    let lastAzanPlayed = "";

    // ==================== GOOGLE SHEETS ====================
    function extractSheetId(url) {
        const match = url.match(/\/d\/([a-zA-Z0-9-_]+)/);
        return match ? match[1] : null;
    }

    function getSheetUrl(sheetId, gid) {
        return `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${gid}`;
    }

    async function loadPrayerTimes(sheetId) {
        try {
            // Default GID for first sheet is 0
            const url = getSheetUrl(sheetId, 0);
            const response = await fetch(url);
            if (!response.ok) throw new Error('Cannot access prayer times sheet');
            
            const csv = await response.text();
            prayerData = parseCSV(csv);
            
            console.log('✅ Prayer times loaded:', prayerData.length, 'records');
            return true;
        } catch (error) {
            console.error('❌ Prayer times error:', error);
            throw error;
        }
    }

    async function loadHijriCalendar(sheetId) {
        try {
            // You need to find the GID of "HijriCalendar" sheet
            // Usually it's the second sheet, so we try common GIDs
            const possibleGids = [1, 2, '1', '2'];
            
            for (let gid of possibleGids) {
                try {
                    const url = getSheetUrl(sheetId, gid);
                    const response = await fetch(url);
                    if (response.ok) {
                        const csv = await response.text();
                        hijriData = parseHijriCSV(csv);
                        console.log('✅ Hijri calendar loaded:', hijriData);
                        return true;
                    }
                } catch (e) {
                    continue;
                }
            }
            
            throw new Error('Cannot find HijriCalendar sheet');
        } catch (error) {
            console.error('❌ Hijri calendar error:', error);
            // Use default if fails
            hijriData = { month: 9, year: 1447, refDate: '2026-03-01', total: 30 };
            return false;
        }
    }

    function parseCSV(csv) {
        const lines = csv.trim().split('\n');
        const data = [];
        
        for (let i = 1; i < lines.length; i++) {
            const values = lines[i].split(',');
            if (values.length >= 9) {
                data.push({
                    start: values[0].trim(),
                    end: values[1].trim(),
                    times: {
                        im: values[2].trim(),
                        fa: values[3].trim(),
                        sh: values[4].trim(),
                        dh: values[5].trim(),
                        as: values[6].trim(),
                        ma: values[7].trim(),
                        is: values[8].trim()
                    }
                });
            }
        }
        
        return data;
    }

    function parseHijriCSV(csv) {
        const lines = csv.trim().split('\n');
        if (lines.length < 2) return null;
        
        const values = lines[1].split(',');
        return {
            month: parseInt(values[0]) || 9,
            year: parseInt(values[1]) || 1447,
            refDate: values[2].trim() || '2026-03-01',
            total: parseInt(values[3]) || 30
        };
    }

    async function loadAllData() {
        if (!CONFIG.sheetsUrl) {
            hideLoading();
            showConfig();
            return;
        }

        const sheetId = extractSheetId(CONFIG.sheetsUrl);
        if (!sheetId) {
            hideLoading();
            Swal.fire({
                icon: 'error',
                title: 'URL ไม่ถูกต้อง',
                text: 'กรุณาตรวจสอบ Google Sheets URL',
                confirmButtonColor: '#064439'
            });
            return;
        }

        try {
            await loadPrayerTimes(sheetId);
            await loadHijriCalendar(sheetId);
            
            hideLoading();
            render();
            
        } catch (error) {
            hideLoading();
            Swal.fire({
                icon: 'error',
                title: 'เชื่อมต่อไม่สำเร็จ',
                html: `
                    <p>ไม่สามารถโหลดข้อมูลจาก Google Sheets</p>
                    <p class="text-sm text-gray-500 mt-2">กรุณาตรวจสอบ:</p>
                    <ul class="text-sm text-left mt-2 text-gray-600">
                        <li>• ตั้งค่าการแชร์เป็น "Anyone with the link"</li>
                        <li>• มี Sheet ชื่อ "PrayerTimes" (Sheet แรก)</li>
                        <li>• มี Sheet ชื่อ "HijriCalendar" (Sheet ที่สอง)</li>
                    </ul>
                `,
                confirmButtonColor: '#064439'
            });
        }
    }

    // ==================== RENDERING ====================
    function render() {
        if (prayerData.length === 0) return;

        const now = new Date();
        const city = CONFIG.city;
        const offset = OFFSETS[city] || 0;
        const todayStr = now.toISOString().split('T')[0];

        // Find active range
        const activeRange = prayerData.find(r => todayStr >= r.start && todayStr <= r.end);
        if (!activeRange) {
            console.warn('No prayer times for today');
            return;
        }

        const baseTimes = activeRange.times;
        const curMin = now.getHours() * 60 + now.getMinutes();
        
        const processed = PRAYER_META.map(p => {
            const [h, m] = baseTimes[p.id].split(':').map(Number);
            const total = h * 60 + m + offset;
            return { ...p, total, str: formatTime(total) };
        });
        
        window.currentPrayerTimes = processed;

        let curIdx = 0;
        for(let i = processed.length - 1; i >= 0; i--) {
            if(curMin >= processed[i].total) { curIdx = i; break; }
        }
        
        const active = processed[curIdx];
        window.nextPrayer = processed[(curIdx + 1) % processed.length];
        window.nextPrayerTotal = window.nextPrayer.total;
        if (curIdx === processed.length - 1) window.nextPrayerTotal += 1440;

        // Update active card
        document.getElementById('nowArName').innerText = active.ar;
        document.getElementById('nowTimeVal').innerText = active.str;
        document.getElementById('nowIconContainer').className = `p-6 rounded-full ${active.bg}`;
        document.getElementById('nowIcon').setAttribute('data-lucide', active.icon);
        document.getElementById('nowIcon').className = `${active.color} w-16 h-16`;

        // Update prayer grid
        const grid = document.getElementById('prayerGrid');
        grid.innerHTML = '';
        processed.forEach((p, idx) => {
            if(idx !== curIdx) {
                grid.innerHTML += `
                    <div class="bg-[#064439] text-white rounded-[28px] p-6 flex flex-col items-center justify-center shadow-lg border border-white/5 transition-transform hover:scale-105">
                        <div class="mb-4 p-2.5 rounded-xl bg-white/10"><i data-lucide="${p.icon}" class="w-5 h-5 text-white"></i></div>
                        <span class="font-amiri text-2xl leading-none mb-3">${p.ar}</span>
                        <span class="text-2xl font-bold font-kanit tracking-tight">${p.str}</span>
                    </div>
                `;
            }
        });

        // Update dates
        const hDate = calculateHijri(now);
        document.getElementById('topHijri').innerText = `${toArNum(hDate.day)} ${AR_MONTHS[hDate.month]} ${toArNum(hijriData.year)}`;
        document.getElementById('topGregorian').innerText = now.toLocaleDateString('th-TH', { day:'numeric', month:'long', year:'numeric' });

        renderHijriCalendar();
        lucide.createIcons();
    }

    function renderHijriCalendar() {
        if (!hijriData) return;

        const ref = new Date(hijriData.refDate);
        const total = hijriData.total;
        const monthAr = AR_MONTHS[hijriData.month];
        
        document.getElementById('calHijriMonth').innerText = monthAr;
        
        const endDate = new Date(ref);
        endDate.setDate(ref.getDate() + total - 1);
        const rangeText = `${ref.getDate()} ${TH_MONTHS[ref.getMonth()]} - ${endDate.getDate()} ${TH_MONTHS[endDate.getMonth()]} ${endDate.getFullYear() + 543}`;
        document.getElementById('calGregorianRange').innerText = rangeText;

        const grid = document.getElementById('hijriGrid');
        grid.innerHTML = '';

        const startDay = ref.getDay();
        for(let i=0; i<startDay; i++) grid.innerHTML += `<div></div>`;

        for(let d=1; d<=total; d++) {
            const currentGreg = new Date(ref);
            currentGreg.setDate(ref.getDate() + d - 1);
            const isToday = currentGreg.toDateString() === new Date().toDateString();
            
            grid.innerHTML += `
                <div class="hijri-cell ${isToday ? 'active' : ''}">
                    <span class="font-amiri text-2xl leading-none">${toArNum(d)}</span>
                    <span class="text-[8px] font-kanit opacity-50 mt-1">${currentGreg.getDate()}</span>
                </div>
            `;
        }
    }

    function calculateHijri(date) {
        if (!hijriData) return { day: 1, month: 9 };
        
        const ref = new Date(hijriData.refDate);
        const diff = Math.floor((date - ref) / 86400000);
        if (diff < 0 || diff >= hijriData.total) return { day: 1, month: hijriData.month };
        return { day: diff + 1, month: hijriData.month };
    }

    // ==================== HELPERS ====================
    function formatTime(m) {
        return `${String(Math.floor(m/60)).padStart(2,'0')}:${String(m%60).padStart(2,'0')}`;
    }

    function toArNum(n) {
        return String(n).split('').map(x => AR_NUMS[x] || x).join('');
    }

    function updateLocation() {
        CONFIG.city = document.getElementById('citySelect').value;
        localStorage.setItem('userCity', CONFIG.city);
        document.getElementById('locLabel').innerText = CONFIG.city;
        render();
    }

    function hideLoading() {
        document.getElementById('loadingScreen').style.display = 'none';
    }

    // ==================== CLOCK & COUNTDOWN ====================
    function tick() {
        const now = new Date();
        const timeStr = now.toLocaleTimeString('th-TH', { hour12: false });
        document.getElementById('liveClock').innerText = timeStr;
        updateCountdown();
        checkAzan(timeStr);
    }

    function updateCountdown() {
        if (!window.nextPrayer) return;
        const now = new Date();
        const curSec = now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds();
        const targetSec = window.nextPrayerTotal * 60;
        
        let diff = targetSec - curSec;
        if (diff < 0) diff = 0;

        const h = Math.floor(diff / 3600);
        const m = Math.floor((diff % 3600) / 60);
        const s = diff % 60;
        
        document.getElementById('countdown').innerText = `อีก ${h} ชม. ${m} นาที ${s} วิ จะเข้าเวลาถัดไป`;
    }

    function checkAzan(currentTime) {
        const prayerTimes = window.currentPrayerTimes;
        if (!prayerTimes) return;
        
        const majorPrayers = ['fa', 'dh', 'as', 'ma', 'is'];
        majorPrayers.forEach(id => {
            const p = prayerTimes.find(x => x.id === id);
            if (p && p.str === currentTime.substring(0, 5)) {
                const currentKey = `${id}-${currentTime.substring(0, 5)}`;
                if (lastAzanPlayed !== currentKey) {
                    playAzan(p.ar);
                    lastAzanPlayed = currentKey;
                }
            }
        });
    }

    function playAzan(prayerName) {
        const audio = document.getElementById('azanAudio');
        audio.currentTime = 0;
        
        Swal.fire({
            title: `<span class="font-amiri" style="font-size: 2em;">${prayerName}</span>`,
            html: '<p class="font-kanit">ได้เวลาละหมาดแล้ว<br>อัซซานกำลังดัง...</p>',
            icon: 'info',
            timer: 10000,
            showConfirmButton: true,
            confirmButtonText: 'รับทราบ',
            confirmButtonColor: '#064439',
            allowOutsideClick: false,
            didOpen: () => {
                audio.play().catch(e => console.log("Audio blocked:", e));
            },
            willClose: () => {
                audio.pause();
                audio.currentTime = 0;
            }
        });
    }

    // ==================== CONFIG MODAL ====================
    function showConfig() {
        document.getElementById('configModal').classList.remove('hidden');
        document.getElementById('sheetsUrl').value = CONFIG.sheetsUrl;
        lucide.createIcons();
    }

    function closeConfig(event) {
        if (!event || event.target.id === 'configModal') {
            document.getElementById('configModal').classList.add('hidden');
        }
    }

    function saveConfig() {
        const url = document.getElementById('sheetsUrl').value.trim();
        if (!url) {
            showStatus('กรุณากรอก URL', 'error');
            return;
        }

        CONFIG.sheetsUrl = url;
        localStorage.setItem('sheetsUrl', url);
        
        showStatus('กำลังโหลดข้อมูล...', 'loading');
        
        setTimeout(() => {
            closeConfig();
            document.getElementById('loadingScreen').style.display = 'flex';
            loadAllData();
        }, 500);
    }

    async function testConnection() {
        const url = document.getElementById('sheetsUrl').value.trim();
        if (!url) {
            showStatus('กรุณากรอก URL', 'error');
            return;
        }

        const sheetId = extractSheetId(url);
        if (!sheetId) {
            showStatus('URL ไม่ถูกต้อง', 'error');
            return;
        }

        showStatus('กำลังทดสอบ...', 'loading');

        try {
            const testUrl = getSheetUrl(sheetId, 0);
            const response = await fetch(testUrl);
            if (response.ok) {
                showStatus('✅ เชื่อมต่อสำเร็จ!', 'success');
            } else {
                showStatus('❌ ไม่สามารถเข้าถึงได้ ตรวจสอบการตั้งค่าการแชร์', 'error');
            }
        } catch (error) {
            showStatus('❌ เกิดข้อผิดพลาด', 'error');
        }
    }

    function showStatus(message, type) {
        const status = document.getElementById('configStatus');
        const colors = {
            'success': 'bg-green-50 text-green-700 border border-green-200',
            'error': 'bg-red-50 text-red-700 border border-red-200',
            'loading': 'bg-blue-50 text-blue-700 border border-blue-200'
        };
        
        status.className = `mt-4 p-4 rounded-xl ${colors[type]}`;
        status.querySelector('p').textContent = message;
        status.classList.remove('hidden');
        
        if (type !== 'loading') {
            setTimeout(() => status.classList.add('hidden'), 3000);
        }
    }

    // ==================== INITIALIZATION ====================
    function init() {
        document.getElementById('citySelect').value = CONFIG.city;
        document.getElementById('locLabel').innerText = CONFIG.city;
        
        setInterval(tick, 1000);
        loadAllData();
        lucide.createIcons();
    }

    window.onload = init;
</script>

</body>
</html>
